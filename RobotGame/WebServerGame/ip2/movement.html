<!DOCTYPE html>
<html>
<head>
	<meta charset="Shift-JIS">
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0" />
	<meta name="apple-mobile-web-app-capable" content="yes" />  
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<title>V-SidoWeb Movement</title>
	
	<link rel="stylesheet" href="./libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css" />
	<script src="./libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="./libs/jqueryui/1.11.2/jquery-ui.min.js"></script>
	<script src="./libs/jquery/jquery.ui.touch-punch.min.js"></script>
	<script src="./libs/common.js"></script>
	<link rel="stylesheet" href="./libs/common.css" />
	
	<!-- V-SidoWeb Apiの挿入 -->
	<script src="./js/vsido.web.js"></script>
	<script>
	$(function(){
		var APP_MODE={
			ANALOG:0,
			SENSOR:1,
		};
		var s_app_mode=APP_MODE.ANALOG;
		
		var vsido=null;
		var qparam=getUrlVars()['setip'];
		if(qparam){
			vsido=new VSidoWeb({'ip':qparam});
		}else{
			vsido=new VSidoWeb();
		}
		var s_walk=vsido.walk();
		
		var s_event_flags=0;
		var s_x_side=0;
		var s_z_forward=0;
		
		function setflag(){s_event_flags=1;}
		function resetflags(){s_event_flags=0;}
		function mainloop(){
			if(!s_event_flags) return;
			s_walk['forward']=s_z_forward;
			s_walk['turn']=s_x_side;
			vsido.send(s_walk);
			resetflags();
		}

		$('#grid').on('click',function(e){
			console.log(e.pageY-$(this).offset().top);
			//setflag();
		});
	
		function checkRange(num){
			var ret=num;
			if(num<-100){ret=-100;}
			else if(num>100){ret=100;}
			return ret;
		}
		$('#grid-cursor').draggable({
			containment:"parent",
			drag:function(event,ui){
				setflag();
				var radius=158-20;
				var x=ui.position.left-radius;
				var y=radius-ui.position.top;
				
				var length=Math.sqrt(Math.pow(x,2)+Math.pow(y,2));
				if(length>radius){
					// vec1(x,y)
					// vec2(1,0)
					var deg=Math.acos(x/length);
					ui.position.left=radius*Math.cos(deg)+radius;
					if(y>0){ui.position.top=radius-radius*Math.sin(deg);}
					else{ui.position.top=radius+radius*Math.sin(deg);}
				}
				
				x=checkRange(Math.floor(100*x/radius));
				y=checkRange(Math.floor(100*y/radius));
				s_z_forward=y;
				s_x_side=x;
				var currvec="x:"+x+",y:"+y;
				$("#z-val").text(currvec);
			},
		})
		.on('mouseup touchend',function(event,ui){
			resetgridview();
			stopmotion();
		});

		function normalize(value){
			var ret=value;
			if(ret>1.0){
				ret=1.0;
			}else if(ret<-1.0){
				ret=-1.0;
			}
			return ret.toFixed(1);
		}
		var ORI_CONST={
			FORWARD_MAX:30,
			SIDE_MAX:30,
		};
		function OriControl(e){
			var px = e.originalEvent.alpha | 0;
			var py = e.originalEvent.beta | 0;
			var pz = e.originalEvent.gamma | 0;
			
			var forward=normalize(-py/ORI_CONST.FORWARD_MAX);
			var side=normalize(pz/ORI_CONST.SIDE_MAX);
			
			var s_x_side=100*side;
			var s_z_forward=100*forward;
			
			var radius=158-20;
			var x=side*radius;
			var y=-forward*radius;
			
			var length=Math.sqrt(Math.pow(x,2)+Math.pow(y,2));
			if(length>radius){
				// vec1(x,y)
				// vec2(1,0)
				var deg=Math.acos(x/length);
				x=radius*Math.cos(deg);
				if(y>0){y=radius*Math.sin(deg);}
				else{
					y=-radius*Math.sin(deg);
				}
			}
			
			$('#grid-cursor').css({
				'top':radius+y+'px',
				'left':radius+x+'px'
			});
			var currvec="x:"+s_x_side+",y:"+s_z_forward;
			$("#z-val").text(currvec);
			setflag();
		}
		function bindDevice(){
			$(window).bind('deviceorientation',OriControl);
		}
		function unbindDevice(){
			$(window).unbind('deviceorientation');
		}
		function resetgridview(){
			$('#grid-cursor').css({
				'top':'138px',
				'left':'138px'
			});
			var currvec="x:0,y:0";
			$("#z-val").text(currvec);
		}
		function stopmotion(){
			s_x_side=0;
			s_z_forward=0;
			setflag();
		}
		$('#pattern-id').on('change',function(event,ui){
			resetgridview();
			stopmotion();
			
			var selectmode=$(this).val();
			if(selectmode==APP_MODE.ANALOG){
				unbindDevice();
			}else if(selectmode==APP_MODE.SENSOR){
				bindDevice();
			}else{
			}
		});
		
		$('#resetbtn')
		.button()
		.on('click',function(event,ui){
			resetgridview();
			stopmotion();
		});
		
		var s_timer=null;
		$(window).on('load pageshow',function(){
			//1秒間66回
			s_timer=setInterval(mainloop,15);
		})
		.on('beforeunload pagehide',function(){
			clearInterval(s_timer);
		});
	});
	</script>

	<style>
	h1{display:none;}
	#content-div{
		margin:5px auto;
		display:table;
	}
	#grid-div{
		display:table-row;
	}
	#pattern-id{
		width:7em;
		font-size:20px;
		font-weight:bold;
	}
	#grid{
		width:316px;
		height:316px;
		border:1px solid white;

		-moz-border-radius:158px;
		-webkit-border-radius:158px;
		border-radius:158px;
		-khtml-border-radius:158px;
		}
	#grid-cursor{
		top:138px;
		left:138px;
		width:40px;
		height:40px;
		background:red;

		-moz-border-radius:20px;
		-webkit-border-radius:20px;
		border-radius:20px;
		-khtml-border-radius:20px;
	}
	#resetbtn{
		font-weight:bold;
		font-size:12px;
		width:6em;
	}
	</style>
</head>

<body>
	<div id="nav-ip">
		<br>
		<h2>IPアドレス</h2>
		<input type="text" id="ip-1" value="">
		<input type="text" id="ip-2" value="">
		<input type="text" id="ip-3" value="">
		<input type="text" id="ip-4" value="">
		<div id="ipset">設定</div>
	</div>
	<div id="nav-div">
		<div class="mainbtn" data-id="0" title="">ホームに戻る</div>
	</div>
	<div id="content-div">
		<h2>コントロール方式</h2>
		<select id="pattern-id" class="ui-selectmenu-text">
			<option value="0" selected>アナログ</option>
			<option value="1">センサー</option>
		</select>
		<div id="grid-div">
			<br><br>
			<div id="grid">
				<div id="grid-cursor"></div>
			</div>
			<h2><label id="z-val">x:0,y:0</label></h2>
		</div>
	</div>
	<div id="info-div">
	<div>
	<div class="spacer"></div>
</body>
</html>
